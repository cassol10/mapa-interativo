<!DOCTYPE html>
<html>
<head>
    <title>Mapa de Trabalhos</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
        }
        
        #sidebar {
            width: 300px;
            background: #f5f5f5;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 15px;
            box-sizing: border-box;
        }
        
        #map {
            flex: 1;
            height: 100vh;
        }
        
        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .work-order-item {
            background: white;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid #3388ff;
        }
        
        .work-order-item:hover {
            background: #f0f7ff;
            transform: translateX(3px);
        }
        
        .work-order-item.fechada {
            border-left-color: #ff3333;
        }
        
        .work-order-item .wo-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .work-order-item .wo-pdo {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .work-order-item .wo-status {
            font-size: 12px;
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            background: #3388ff;
            color: white;
        }
        
        .work-order-item.fechada .wo-status {
            background: #ff3333;
        }
        
        .custom-popup {
            min-width: 250px;
            padding: 10px;
        }
        
        /* Estilos dos pins e popups (manter os mesmos do anterior) */
        .pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #3388ff;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -20px 0 0 -15px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        .pin:after {
            content: "";
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: rgba(255,255,255,0.8);
            position: absolute;
            border-radius: 50%;
        }
        
        .pin.fechada {
            background: #ff3333;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-title">Ordens de Serviço</div>
        <div id="work-orders-list"></div>
    </div>
    
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Inicializa o mapa
        var map = L.map('map').setView([38.825, -9.155], 14);

        // Adiciona os tiles do OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Dados dos pontos
        var dataPoints = [
            {
                wo: "WO 16903160",
                pdo: "PDO-92-LOU-0161.33",
                desc: "Normal",
                coords: [38.817256, -9.165423],
                status: "aberta",
                responsavel: ""
            },
            {
                wo: "WO 16910762",
                pdo: "PDO-92-LOU-0010.13",
                desc: "Normal",
                coords: [38.837121, -9.156680],
                status: "aberta",
                responsavel: ""
            },
            {
                wo: "WO 16922859",
                pdo: "PDO-92-LOU-1259.2",
                desc: "Normal",
                coords: [38.822771, -9.144502],
                status: "aberta",
                responsavel: ""
            }
        ];

        // Objeto para armazenar os marcadores
        var markers = {};
        var workOrderItems = {};

        // Cria ícones personalizados
        function createCustomIcon(isClosed) {
            return L.divIcon({
                className: 'custom-icon',
                html: `<div class="pin ${isClosed ? 'fechada' : ''}"></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -30]
            });
        }

        // Atualiza o item na lista
        function updateWorkOrderItem(wo, status) {
            var item = workOrderItems[wo];
            if (status === "fechada") {
                item.classList.add('fechada');
                item.querySelector('.wo-status').textContent = "Fechada";
                item.querySelector('.wo-status').style.backgroundColor = "#ff3333";
            } else {
                item.classList.remove('fechada');
                item.querySelector('.wo-status').textContent = "Aberta";
                item.querySelector('.wo-status').style.backgroundColor = "#3388ff";
            }
        }

        // Adiciona marcadores para cada ponto de dados
        dataPoints.forEach(function(point) {
            // Cria o conteúdo do popup
            var popupContent = `
                <div class="custom-popup">
                    <strong>WO:</strong> ${point.wo}<br>
                    <strong>PDO:</strong> ${point.pdo}<br>
                    <strong>Descrição:</strong> ${point.desc}<br><br>
                    
                    <div class="checkbox-group">
                        <strong>Status:</strong>
                        <div class="checkbox-line">
                            <input type="radio" id="aberta-${point.wo}" name="status-${point.wo}" value="aberta" ${point.status === 'aberta' ? 'checked' : ''}>
                            <label for="aberta-${point.wo}">Aberta</label>
                        </div>
                        <div class="checkbox-line">
                            <input type="radio" id="fechada-${point.wo}" name="status-${point.wo}" value="fechada" ${point.status === 'fechada' ? 'checked' : ''}>
                            <label for="fechada-${point.wo}">Fechada</label>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <strong>Responsável:</strong>
                        <div class="checkbox-line">
                            <input type="radio" id="pedro-${point.wo}" name="responsavel-${point.wo}" value="pedro" ${point.responsavel === 'pedro' ? 'checked' : ''}>
                            <label for="pedro-${point.wo}">Pedro</label>
                        </div>
                        <div class="checkbox-line">
                            <input type="radio" id="amorim-${point.wo}" name="responsavel-${point.wo}" value="amorim" ${point.responsavel === 'amorim' ? 'checked' : ''}>
                            <label for="amorim-${point.wo}">Amorim</label>
                        </div>
                    </div>
                </div>
            `;
            
            // Cria o marcador
            markers[point.wo] = L.marker(point.coords, {
                icon: createCustomIcon(point.status === "fechada")
            }).addTo(map).bindPopup(popupContent);
            
            // Cria o item na lista
            var item = document.createElement('div');
            item.className = `work-order-item ${point.status === "fechada" ? "fechada" : ""}`;
            item.innerHTML = `
                <div class="wo-number">${point.wo}</div>
                <div class="wo-pdo">${point.pdo}</div>
                <div class="wo-status">${point.status === "fechada" ? "Fechada" : "Aberta"}</div>
            `;
            
            // Armazena referência do item
            workOrderItems[point.wo] = item;
            
            // Adiciona à lista
            document.getElementById('work-orders-list').appendChild(item);
            
            // Evento de clique no item da lista
            item.addEventListener('click', function() {
                markers[point.wo].openPopup();
                map.setView(point.coords, 16);
            });
            
            // Adiciona evento quando o popup abre
            markers[point.wo].on('popupopen', function() {
                // Obtém os radio buttons
                var fechadaRadio = document.getElementById(`fechada-${point.wo}`);
                var abertaRadio = document.getElementById(`aberta-${point.wo}`);
                
                // Adiciona eventos de mudança
                fechadaRadio.addEventListener('change', function() {
                    if (this.checked) {
                        markers[point.wo].setIcon(createCustomIcon(true));
                        point.status = "fechada";
                        updateWorkOrderItem(point.wo, "fechada");
                    }
                });
                
                abertaRadio.addEventListener('change', function() {
                    if (this.checked) {
                        markers[point.wo].setIcon(createCustomIcon(false));
                        point.status = "aberta";
                        updateWorkOrderItem(point.wo, "aberta");
                    }
                });
                
                // Eventos para o responsável
                var pedroRadio = document.getElementById(`pedro-${point.wo}`);
                var amorimRadio = document.getElementById(`amorim-${point.wo}`);
                
                pedroRadio.addEventListener('change', function() {
                    if (this.checked) {
                        point.responsavel = "pedro";
                    }
                });
                
                amorimRadio.addEventListener('change', function() {
                    if (this.checked) {
                        point.responsavel = "amorim";
                    }
                });
            });
        });

        // Centraliza o mapa para mostrar todos os marcadores
        function fitMapToMarkers() {
            var markerGroup = new L.featureGroup();
            dataPoints.forEach(function(point) {
                markerGroup.addLayer(markers[point.wo]);
            });
            map.fitBounds(markerGroup.getBounds().pad(0.2));
        }

        // Ajusta o mapa após um pequeno delay para garantir que tudo está carregado
        setTimeout(fitMapToMarkers, 100);
    </script>
</body>
</html>